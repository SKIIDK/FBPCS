name: pyre

on: [push, pull_request]
jobs:
  create-virtualenv:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v1
    - uses: syphar/restore-virtualenv@v1
      id: cache-virtualenv

    - uses: syphar/restore-pip-download-cache@v1
      if: steps.cache-virtualenv.outputs.cache-hit != 'true'
    - run: python3 -m pip install -r requirements.txt
      if: steps.cache-virtualenv.outputs.cache-hit != 'true'
    - name: Install Dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install .
        VERSION=$(grep "version" .pyre_configuration | sed -n -e 's/.*\(0\.0\.[0-9]*\).*/\1/p')
        python3 -m pip install pyre-check-nightly==$VERSION

      
  pyre:
    needs: create-virtualenv
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
      - uses: syphar/restore-virtualenv@v1
        id: cache-virtualenv
      - name: Run Pyre
        run: |
          pyre check
